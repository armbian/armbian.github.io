name: "Reporting: Release summary"

on:
  workflow_dispatch:
    inputs:
      scope:
        description: "Comma-separated repos (owner/repo) OR 'org:armbian'"
        required: false
        default: "org:armbian"
      tz:
        description: "Timezone (IANA)"
        required: false
        default: "Europe/Ljubljana"
      period:
        description: "Digest period (weekly by default). Choose 'monthly' or 'quarterly' for larger windows."
        required: false
        default: "weekly"
      publish_release:
        description: "Publish a GitHub release (true/false)."
        required: false
        default: "true"

  schedule:
    - cron: "5 6 * * MON"   # weekly, Mondays 06:05 UTC

permissions:
  contents: read

jobs:
  pr-digest:
    name: "Get PR's"
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.AI_MODELS }}
      SCOPE: ${{ inputs.scope || 'org:armbian' }}
      TZ: ${{ inputs.tz || 'Europe/Ljubljana' }}
      PERIOD: ${{ inputs.period || 'weekly' }}
      RELEASE_ENABLED: ${{ inputs.publish_release || 'true' }}

    steps:

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install OpenAI SDK
        run: pip install 'openai>=1.0.0'

      - name: Ensure dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Compute time window (UTC) from period
        id: when
        shell: bash
        run: |
          set -euo pipefail
          export PERIOD="${PERIOD:-weekly}"
          UNTIL_UTC="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          if [[ "$PERIOD" == "monthly" ]]; then
            SINCE_UTC="$(date -u -d '1 month ago' +%Y-%m-%dT%H:%M:%SZ)"
            LABEL="Monthly digest"
          elif [[ "$PERIOD" == "quarterly" ]]; then
            SINCE_UTC="$(date -u -d '3 months ago' +%Y-%m-%dT%H:%M:%SZ)"
            LABEL="Quarterly digest"
          else
            SINCE_UTC="$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)"
            LABEL="Weekly digest"
          fi
          echo "UNTIL_UTC=$UNTIL_UTC" >> "$GITHUB_ENV"
          echo "SINCE_UTC=$SINCE_UTC" >> "$GITHUB_ENV"
          echo "LABEL=$LABEL" >> "$GITHUB_ENV"

      - name: Prepare workspace
        run: mkdir -p out

      - name: Write helper script
        shell: bash
        run: |
          cat > pr_fetch.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          scope="${1:?}"     # "org:armbian" or "owner/repo,owner/repo2"
          since="${2:?}"     # ISO UTC
          until="${3:?}"     # ISO UTC
          outfile="${4:?}"   # path

          collect() {
            local q="$1"
            gh api -X GET search/issues \
              -f q="$q" \
              -f sort="updated" -f order="desc" \
              -f per_page=100 --paginate \
              -q '.items[] | {number: .number, repo: (.repository_url | sub("^.*/repos/";""))}'
          }

          tmp="$(mktemp)"
          if [[ "$scope" == org:* ]]; then
            org="${scope#org:}"
            q="org:${org} is:pr is:merged merged:${since}..${until} archived:false"
            collect "$q" > "$tmp"
          else
            IFS=',' read -r -a repos <<< "$scope"
            : > "$tmp"
            for r in "${repos[@]}"; do
              r_trim="$(echo "$r" | xargs)"
              q="repo:${r_trim} is:pr is:merged merged:${since}..${until}"
              collect "$q" >> "$tmp"
            done
          fi

          # De-dup and enrich, then output TSV sorted alphabetically by title (case-insensitive)
          jq -s 'unique_by(.repo + "|" + (.number|tostring))' "$tmp" | jq -c '.[]' | \
          while read -r row; do
            repo=$(echo "$row" | jq -r .repo)
            num=$(echo "$row"  | jq -r .number)
            pr=$(gh api "repos/${repo}/pulls/${num}")

            title=$(jq -r .title <<<"$pr")
            author=$(jq -r .user.login <<<"$pr")
            pr_url=$(jq -r .html_url <<<"$pr")

            # Skip bots and worker accounts
            if [[ "$author" == "github-actions[bot]" || "$author" == "dependabot[bot]" || "$author" == "armbianworker" || "$author" == "armbianworker[bot]" ]]; then
              continue
            fi

            # Output tab-separated: title, author, repo, pr_number, pr_url
            printf "%s\t%s\t%s\t%s\t%s\n" "$title" "$author" "$repo" "$num" "$pr_url"
          done | LC_ALL=C sort -f -t $'\t' -k1,1 > "$outfile"
          EOF
          chmod +x pr_fetch.sh

      - name: Fetch merged PRs for selected period
        run: ./pr_fetch.sh "$SCOPE" "$SINCE_UTC" "$UNTIL_UTC" out/pr-digest.tsv

      - name: "Write Markdown digest"
        shell: bash
        run: |

            echo "" >> summary.md
            echo "## " >> summary.md
            if [[ ! -s out/pr-digest.tsv ]]; then
              echo "_No merged PRs in this period._" >> summary.md
            else
              while IFS=$'\t' read -r title author repo num pr_url; do
                echo "* ${title}.  by @${author} in [${repo}#${num}](${pr_url})" >> summary.md
              done < out/pr-digest.tsv
            fi
            echo "# " >> summary.md
            echo "<a href='https://blog.armbian.com/#/portal/signup' target='_blank'>
                  <img src='https://img.shields.io/badge/Subscribe-blog.armbian.com-red?style=for-the-badge&logo=rss' alt='Subscribe to Blog'/></a>" >> summary.md
            echo "<p><br>Stay up to date with the latest Armbian news, development highlights, and tips â€” delivered straight to your inbox." >> summary.md

      - name: "Generate HTML digest table"
        shell: bash
        run: |
          cat > out/digest.html <<'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>${LABEL} - Armbian PR Digest</title>
              <style>
                  :root {
                      --bg-primary: #0d1117;
                      --bg-secondary: #161b22;
                      --bg-tertiary: #21262d;
                      --border-color: #30363d;
                      --text-primary: #c9d1d9;
                      --text-secondary: #8b949e;
                      --text-muted: #6e7681;
                      --accent: #58a6ff;
                      --accent-hover: #79c0ff;
                      --success: #3fb950;
                      --armbian-orange: #f88a29;
                      --armbian-blue: #007bff;
                  }
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                      background: var(--bg-primary);
                      color: var(--text-primary);
                      line-height: 1.6;
                      padding: 20px;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                  }
                  header {
                      text-align: center;
                      padding: 40px 20px;
                      border-bottom: 1px solid var(--border-color);
                      margin-bottom: 30px;
                  }
                  h1 {
                      font-size: 2.5rem;
                      margin-bottom: 10px;
                      background: linear-gradient(135deg, var(--armbian-orange), var(--armbian-blue));
                      -webkit-background-clip: text;
                      -webkit-text-fill-color: transparent;
                      background-clip: text;
                  }
                  .subtitle {
                      color: var(--text-secondary);
                      font-size: 1.1rem;
                  }
                  .meta {
                      display: flex;
                      justify-content: center;
                      gap: 20px;
                      flex-wrap: wrap;
                      margin-bottom: 20px;
                  }
                  .meta-item {
                      background: var(--bg-secondary);
                      padding: 8px 16px;
                      border-radius: 6px;
                      font-size: 0.9rem;
                  }
                  .table-container {
                      background: var(--bg-secondary);
                      border-radius: 12px;
                      overflow: hidden;
                      border: 1px solid var(--border-color);
                      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                  }
                  table {
                      width: 100%;
                      border-collapse: collapse;
                  }
                  thead {
                      background: var(--bg-tertiary);
                  }
                  th {
                      padding: 16px;
                      text-align: left;
                      font-weight: 600;
                      color: var(--text-primary);
                      border-bottom: 2px solid var(--border-color);
                      font-size: 0.85rem;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                  }
                  td {
                      padding: 14px 16px;
                      border-bottom: 1px solid var(--border-color);
                      vertical-align: middle;
                  }
                  tr:last-child td {
                      border-bottom: none;
                  }
                  tr:hover {
                      background: var(--bg-tertiary);
                  }
                  .pr-title {
                      font-weight: 500;
                      color: var(--text-primary);
                      margin-bottom: 6px;
                  }
                  .pr-meta {
                      display: flex;
                      gap: 8px;
                      flex-wrap: wrap;
                      align-items: center;
                  }
                  .badge {
                      display: inline-block;
                      padding: 3px 10px;
                      border-radius: 12px;
                      font-size: 0.75rem;
                      font-weight: 500;
                  }
                  .badge-repo {
                      background: rgba(88, 166, 255, 0.15);
                      color: var(--accent);
                      border: 1px solid rgba(88, 166, 255, 0.3);
                  }
                  .badge-author {
                      background: rgba(248, 138, 41, 0.15);
                      color: var(--armbian-orange);
                      border: 1px solid rgba(248, 138, 41, 0.3);
                  }
                  .pr-link {
                      color: var(--accent);
                      text-decoration: none;
                      font-size: 0.9rem;
                      display: inline-flex;
                      align-items: center;
                  }
                  .pr-link:hover {
                      color: var(--accent-hover);
                      text-decoration: underline;
                  }
                  .pr-link::before {
                      content: "â†’";
                      margin-right: 6px;
                  }
                  .no-prs {
                      text-align: center;
                      padding: 60px 20px;
                      color: var(--text-muted);
                      font-size: 1.1rem;
                  }
                  .no-prs-icon {
                      font-size: 3rem;
                      margin-bottom: 16px;
                      opacity: 0.5;
                  }
                  footer {
                      margin-top: 40px;
                      text-align: center;
                      padding: 30px 20px;
                      border-top: 1px solid var(--border-color);
                      color: var(--text-secondary);
                  }
                  .footer-link {
                      color: var(--accent);
                      text-decoration: none;
                      font-weight: 500;
                  }
                  .footer-link:hover {
                      text-decoration: underline;
                  }
                  .generated-time {
                      margin-top: 10px;
                      font-size: 0.85rem;
                      color: var(--text-muted);
                  }
                  @media (max-width: 768px) {
                      .meta {
                          flex-direction: column;
                      }
                      .pr-meta {
                          flex-direction: column;
                          gap: 6px;
                      }
                      th, td {
                          padding: 12px;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>${LABEL}</h1>
                      <p class="subtitle">Armbian Pull Request Digest</p>
                      <div class="meta">
                          <div class="meta-item">ðŸ“… Period: ${PERIOD}</div>
                          <div class="meta-item">ðŸ“… From: ${SINCE_UTC}</div>
                          <div class="meta-item">ðŸ“… Until: ${UNTIL_UTC}</div>
                      </div>
                  </header>
          HTMLEOF

          # Generate table rows
          if [[ ! -s out/pr-digest.tsv ]]; then
              cat >> out/digest.html <<'EOF'
                  <div class="table-container">
                      <div class="no-prs">
                          <div class="no-prs-icon">ðŸ“­</div>
                          <p>No merged PRs in this period.</p>
                      </div>
                  </div>
          EOF
          else
              cat >> out/digest.html <<'EOF'
                  <div class="table-container">
                      <table>
                          <thead>
                              <tr>
                                  <th width="50%">Pull Request</th>
                                  <th>Author</th>
                                  <th>Repository</th>
                                  <th>Link</th>
                              </tr>
                          </thead>
                          <tbody>
          EOF

              while IFS=$'\t' read -r title author repo num pr_url; do
                  repo_name="${repo##*/}"
                  cat >> out/digest.html <<EOF
                              <tr>
                                  <td>
                                      <div class="pr-title">${title}</div>
                                      <div class="pr-meta">
                                          <span class="badge badge-repo">${repo_name}</span>
                                      </div>
                                  </td>
                                  <td><span class="badge badge-author">@${author}</span></td>
                                  <td>${repo_name}</td>
                                  <td><a class="pr-link" href="${pr_url}" target="_blank">View PR #${num}</a></td>
                              </tr>
          EOF
              done < out/pr-digest.tsv

              cat >> out/digest.html <<'EOF'
                          </tbody>
                      </table>
                  </div>
          EOF
          fi

          cat >> out/digest.html <<'EOF'
                  <footer>
                      <a class="footer-link" href="https://blog.armbian.com/#/portal/signup" target="_blank">
                          ðŸ“¬ Subscribe to Armbian Blog
                      </a>
                      <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-muted);">
                          Stay up to date with the latest Armbian news, development highlights, and tips.
                      </p>
                      <div class="generated-time">
                          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                      </div>
                  </footer>
              </div>
          </body>
          </html>
          HTMLEOF

      - name: Upload raw data (artifacts)
        uses: actions/upload-artifact@v6
        with:
          name: pr-digest
          path: out/
          if-no-files-found: warn

      - name: "Checkout OS repository to get version"
        uses: actions/checkout@v6
        with:
          repository: armbian/os
          fetch-depth: 0
          clean: false
          path: os

      - name: "Read version from nightly or stable based on period"
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${PERIOD:-weekly}" == "monthly" || "${PERIOD:-weekly}" == "quarterly" ]]; then
            FILE="os/stable.json"
          else
            FILE="os/nightly.json"
          fi
          if [[ ! -f "$FILE" ]]; then
            echo "::error file=$FILE::Version file not found"
            exit 1
          fi
          VERSION=$(jq -r '.version' "$FILE")
          echo "VERSION_OVERRIDE=${VERSION}" >> "$GITHUB_ENV"

      - name: "Write a short journalistic intro with AI"
        if: ${{ env.PERIOD == 'weekly' }}
        run: |
          set -euo pipefail
          python3 <<'PY'
          import os
          from openai import OpenAI

          token = os.environ["GITHUB_TOKEN"]
          label = os.environ["LABEL"]

          with open("summary.md", "r", encoding="utf-8") as f:
              content = f.read().strip()

          client = OpenAI(base_url="https://models.github.ai/inference", api_key=token)

          prompt = (
              "Read the following Markdown changelog and write a short journalistic intro paragraph (5â€“7 sentences) "
              "that summarizes the main activity. Be concise, professional, and factual. Output only the intro.\n\n"
              f"{content}"
          )

          resp = client.chat.completions.create(
              model="openai/gpt-4.1",
              messages=[
                  {"role": "system", "content": "You are a " + label + "digest editor."},
                  {"role": "user", "content": prompt},
              ],
              temperature=0.3,
              top_p=1.0,
          )

          intro = resp.choices[0].message.content.strip()

          with open("summary.md", "w", encoding="utf-8") as f:
              f.write(intro + "\n\n" + content)

          print("Prepended AI intro:")
          print(intro)
          PY
          cat summary.md >> "$GITHUB_STEP_SUMMARY"

      - uses: ncipollo/release-action@v1
        if: ${{ env.RELEASE_ENABLED == 'true' }}
        with:
          owner: 'armbian'
          repo: 'build'
          tag: "v${{ env.VERSION_OVERRIDE }}"
          name: "${{ env.LABEL }}"
          generateReleaseNotes: "false"
          prerelease: "false"
          makeLatest: "true"
          bodyFile: "summary.md"
          allowUpdates: "true"
          skipIfReleaseExists: "true"
          token: ${{ secrets.RELEASE_TOKEN }}
