name: "Data: Update Torrent Trackers"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    name: "Generate announce list"
    steps:
      # Checkout YOUR repo
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      # Clone the torrent lists
      - name: "Checkout torrent lists"
        uses: actions/checkout@v6
        with:
          repository: XIU2/TrackersListCollection
          clean: false
          ref: master
          path: trackerslist
          fetch-depth: 1

      - name: "Prepare torrent TRACKERS"
        shell: bash
        run: |
          set -euo pipefail

          echo "Collecting trackers from XIU2/TrackersListCollection"

          # Generate output file with --announce= prefix
          grep -v '^[[:space:]]*$' trackerslist/best.txt \
            | sort -R \
            | sed 's/^/ --announce=/' > /tmp/best-torrent-servers.txt

          echo "Generated $(wc -l < /tmp/best-torrent-servers.txt) tracker entries"

          # Add to GitHub step summary
          {
            echo "### Torrent Trackers"
            echo '```'
            cat /tmp/best-torrent-servers.txt
            echo '```'
          } >> $GITHUB_STEP_SUMMARY

      - name: Commit to data branch
        run: |
          set -euo pipefail

          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          git fetch origin data
          git checkout -b data origin/data || git checkout -b data
          git pull --rebase origin data

          mkdir -p data/servers
          cp /tmp/best-torrent-servers.txt data/servers/best-torrent-servers.txt

          git add data/servers/best-torrent-servers.txt
          if ! git diff --cached --quiet; then
            git commit -m "Update torrent trackers"
            # rebase once more right before push to reduce race window
            git pull --rebase origin data
            git push origin data
          fi

      - name: Trigger webindex-update workflow
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: "Web: Directory listing"
