name: "Data: Update partners data"

on:
  repository_dispatch:
    types: ["Data: Update partners data"]
  workflow_dispatch:
concurrency:
  group: redirector
  cancel-in-progress: false

jobs:
  fetch-bigin-data:
    runs-on: ubuntu-latest
    name: "Fetch data"
    if: ${{ github.repository_owner == 'Armbian' }}
    permissions:
      contents: write
    steps:
      - name: Checkout armbian.github.io repository
        uses: actions/checkout@v6
        with:
          repository: armbian/armbian.github.io
          fetch-depth: 0
          clean: false
          path: armbian.github.io

      - name: Fetch and generate partner JSON files
        env:
          CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ACCESS_TOKEN=$(curl -sH "Content-type: multipart/form-data" \
            -F refresh_token=$REFRESH_TOKEN \
            -F client_id=$CLIENT_ID \
            -F client_secret=$CLIENT_SECRET \
            -F grant_type=refresh_token \
            -X POST https://accounts.zoho.eu/oauth/v2/token \
            | jq -r '.access_token')

          echo "Access token obtained."

          # Fetch all partners and combine into single JSON file
          > partners.json

          for partner_type in Platinum Gold Silver; do
            curl --silent --request GET \
              --url "https://www.zohoapis.eu/bigin/v2/Accounts/search?fields=Website,Company_slug,Description,Account_Name,Email,Partnership_Status,Promoted&criteria=((Partnership_Status:equals:${partner_type}%20Partner)and(Promoted:equals:true))" \
              --header "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
              | jq -c ".data[] | select(.Company_slug != null and .Company_slug != \"\") | {
                  Account_Name,
                  logo_url: (\"https://cache.armbian.com/images/vendors/150/\(.Company_slug).png\"),
                  Website,
                  Description,
                  Partnership_Status: .Partnership_Status
                }" >> partners.json
          done

          # Format the JSON array
          jq -s . < partners.json > partners.json.tmp && mv partners.json.tmp partners.json
          jq . -S < partners.json > partners.json.tmp && mv partners.json.tmp partners.json

          # Display content in step summary as HTML table
          echo "<h1>Partners</h1>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to generate partner table row
          generate_table_row() {
            local partner_status=$1
            local img_width=$2
            local partners_per_row=$3

            local partners=$(jq -c ".[] | select(.Partnership_Status == \"$partner_status\")" partners.json)
            local partner_count=$(echo "$partners" | jq -s 'length')

            if [ $partner_count -eq 0 ]; then
              return
            fi

            echo '<table role="presentation" cellspacing="0" cellpadding="10" border="0" bgcolor="#ffffff">' >> $GITHUB_STEP_SUMMARY
            echo "  <tr>" >> $GITHUB_STEP_SUMMARY
            echo "    <td colspan=\"$((partners_per_row * 2 - 1))\" align=\"left\"><strong>$partner_status</strong></td>" >> $GITHUB_STEP_SUMMARY
            echo "  </tr>" >> $GITHUB_STEP_SUMMARY

            local row=0
            local col=0

            echo "$partners" | while read -r partner; do
              if [ $col -eq 0 ]; then
                echo "  <tr>" >> $GITHUB_STEP_SUMMARY
              fi

              local website=$(echo "$partner" | jq -r '.Website')
              local logo_url=$(echo "$partner" | jq -r '.logo_url')
              local account_name=$(echo "$partner" | jq -r '.Account_Name')

              echo "    <td align=\"center\" valign=\"middle\" bgcolor=\"#ffffff\">" >> $GITHUB_STEP_SUMMARY
              echo "      <a href=\"$website\"><img src=\"$logo_url\" width=\"$img_width\" alt=\"$account_name\"></a>" >> $GITHUB_STEP_SUMMARY
              echo "    </td>" >> $GITHUB_STEP_SUMMARY

              if [ $col -lt $((partners_per_row - 1)) ]; then
                echo "    <td width=\"20\">&nbsp;</td>" >> $GITHUB_STEP_SUMMARY
              fi

              col=$((col + 1))

              if [ $col -eq $partners_per_row ]; then
                # Fill remaining cells if needed
                for ((i=col; i<partners_per_row; i++)); do
                  echo "    <td>&nbsp;</td>" >> $GITHUB_STEP_SUMMARY
                  if [ $i -lt $((partners_per_row - 1)) ]; then
                    echo "    <td width=\"20\">&nbsp;</td>" >> $GITHUB_STEP_SUMMARY
                  fi
                done
                echo "  </tr>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "  <tr><td colspan=\"$((partners_per_row * 2 - 1))\" height=\"16\">&nbsp;</td></tr>" >> $GITHUB_STEP_SUMMARY
                col=0
              fi
            done

            # Close row if incomplete
            if [ $col -ne 0 ]; then
              for ((i=col; i<partners_per_row; i++)); do
                echo "    <td>&nbsp;</td>" >> $GITHUB_STEP_SUMMARY
                if [ $i -lt $((partners_per_row - 1)) ]; then
                  echo "    <td width=\"20\">&nbsp;</td>" >> $GITHUB_STEP_SUMMARY
                fi
              done
              echo "  </tr>" >> $GITHUB_STEP_SUMMARY
            fi

            echo "</table>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          }

          # Generate tables for each partner tier
          generate_table_row "Platinum Partner" 150 4
          generate_table_row "Gold Partner" 105 6
          generate_table_row "Silver Partner" 75 8

          # Create a temporary file for maintainers_with_avatars.json
          temp_file=$(mktemp)

          # Start the JSON array
          echo "[" > "$temp_file"

          # Flag for commas between records
          first=1

          # Fetch the maintainers from Zoho Bigin
          curl --silent --request GET \
            --url 'https://www.zohoapis.eu/bigin/v2/Contacts/search?fields=Team,First_Name,Github,Maintaining,Your_core_competences&criteria=((Tag:equals:maintainer)and(Inactive:equals:false))' \
            --header "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
          | jq -c '.data[] | {First_Name, Github, Team, Maintaining, Your_core_competences}' \
          | while read -r row; do
              # Extract GitHub username from the URL
              github_url=$(echo "$row" | jq -r '.Github')
              username=$(basename "$github_url")

              # Assume GH_TOKEN is exported as env var or injected from GitHub Actions secrets
              auth_header="Authorization: token $GH_TOKEN"

              # Fetch GitHub profile for avatar URL
              avatar_url=$(curl -s -H "$auth_header" "https://api.github.com/users/$username" | jq -r '.avatar_url')

              # Enrich Zoho data with GitHub avatar
              enriched=$(echo "$row" | jq --arg avatar "$avatar_url" '. + {Avatar: $avatar}')

              # Manage commas between JSON objects
              if [ $first -eq 1 ]; then
                first=0
              else
                echo -e "," >> "$temp_file"
              fi

              # Write the enriched data to the temporary file
              echo "$enriched" >> "$temp_file"
          done

          # Close the JSON array
          echo "]" >> "$temp_file"

          # Format and save the final output to fixed.json
          cat "$temp_file" | jq . > maintainers.json

          # Clean up the temporary file
          rm "$temp_file"

      - name: Commit and push JSON files
        run: |

          cd armbian.github.io
          git checkout data
          mkdir -p data/
          cp ${{ github.workspace }}/partners.json data/
          cp ${{ github.workspace }}/maintainers.json data/
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/partners.json data/maintainers.json
          git commit -m "Update of Bigin sourced JSON files" || echo "No changes to commit"
          git push

      - name: "Run base-files update action"
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: "Data: Update base-files info"
