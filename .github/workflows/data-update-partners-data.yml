name: "Data: Update partners and maintainers"

on:
  repository_dispatch:
    types: ["Data: Update partners and maintainers"]
  workflow_dispatch:
  schedule:
    - cron: '30 5 * * *'
concurrency:
  group: redirector
  cancel-in-progress: false

jobs:
  fetch-bigin-data:
    runs-on: ubuntu-latest
    name: "Fetch data"
    if: ${{ github.repository_owner == 'Armbian' }}
    permissions:
      contents: write
    steps:
      - name: Checkout armbian.github.io repository
        uses: actions/checkout@v6
        with:
          repository: armbian/armbian.github.io
          fetch-depth: 0
          clean: false
          path: armbian.github.io

      - name: Fetch and generate partner JSON files
        env:
          CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ACCESS_TOKEN=$(curl -sH "Content-type: multipart/form-data" \
            -F refresh_token=$REFRESH_TOKEN \
            -F client_id=$CLIENT_ID \
            -F client_secret=$CLIENT_SECRET \
            -F grant_type=refresh_token \
            -X POST https://accounts.zoho.eu/oauth/v2/token \
            | jq -r '.access_token')

          echo "Access token obtained."

          # Fetch all partners and combine into single JSON file
          > partners.json

          for partner_type in Platinum Gold Silver; do
            curl --silent --request GET \
              --url "https://www.zohoapis.eu/bigin/v2/Accounts/search?fields=Website,Company_slug,Description,Account_Name,Email,Partnership_Status,Promoted&criteria=((Partnership_Status:equals:${partner_type}%20Partner)and(Promoted:equals:true))" \
              --header "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
              | jq -c ".data[] | select(.Company_slug != null and .Company_slug != \"\") | {
                  Account_Name,
                  logo_url: (\"https://cache.armbian.com/images/vendors/150/\(.Company_slug)-border.png\"),
                  Website,
                  Description,
                  Partnership_Status: .Partnership_Status
                }" >> partners.json
          done

          # Format the JSON array
          jq -s . < partners.json > partners.json.tmp && mv partners.json.tmp partners.json
          jq . -S < partners.json > partners.json.tmp && mv partners.json.tmp partners.json

          # Display content in step summary as markdown sections
          echo "# Partners" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Platinum Partners
          echo "## Platinum" >> $GITHUB_STEP_SUMMARY
          echo '<p align=left>' >> $GITHUB_STEP_SUMMARY
          TIMESTAMP=$(date +%s)
          jq -r --arg ts "$TIMESTAMP" '.[] | select(.Partnership_Status == "Platinum Partner") |
            "<a href='\''\(.Website)'\''><img src='\''\(.logo_url)?v=\($ts)'\'' width='\''150'\'' alt='\''\(.Account_Name)'\'' style=\"display:block; border:0; height:auto;\"></a>"' \
            partners.json | tr '\n' ' ' >> $GITHUB_STEP_SUMMARY
          echo '</p>' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Gold Partners
          echo "## Gold" >> $GITHUB_STEP_SUMMARY
          echo '<p align=left>' >> $GITHUB_STEP_SUMMARY
          jq -r --arg ts "$TIMESTAMP" '.[] | select(.Partnership_Status == "Gold Partner") |
            "<a href='\''\(.Website)'\''><img src='\''\(.logo_url)?v=\($ts)'\'' width='\''105'\'' alt='\''\(.Account_Name)'\'' style=\"display:block; border:0; height:auto;\"></a>"' \
            partners.json | tr '\n' ' ' >> $GITHUB_STEP_SUMMARY
          echo '</p>' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Silver Partners
          echo "## Silver" >> $GITHUB_STEP_SUMMARY
          echo '<p align=left>' >> $GITHUB_STEP_SUMMARY
          jq -r --arg ts "$TIMESTAMP" '.[] | select(.Partnership_Status == "Silver Partner") |
            "<a href='\''\(.Website)'\''><img src='\''\(.logo_url)?v=\($ts)'\'' width='\''75'\'' alt='\''\(.Account_Name)'\'' style=\"display:block; border:0; height:auto;\"></a>"' \
            partners.json | tr '\n' ' ' >> $GITHUB_STEP_SUMMARY
          echo '</p>' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Create a temporary file for maintainers_with_avatars.json
          temp_file=$(mktemp)

          # Start the JSON array
          echo "[" > "$temp_file"

          # Flag for commas between records
          first=1

          # Fetch the maintainers from Zoho Bigin
          curl --silent --request GET \
            --url 'https://www.zohoapis.eu/bigin/v2/Contacts/search?fields=Team,First_Name,Github,Maintaining,Your_core_competences&criteria=((Tag:equals:maintainer)and(Inactive:equals:false))' \
            --header "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
          | jq -c '.data[] | {First_Name, Github, Team, Maintaining, Your_core_competences}' \
          | while read -r row; do
              # Extract GitHub username from the URL
              github_url=$(echo "$row" | jq -r '.Github')
              username=$(basename "$github_url")

              # Assume GH_TOKEN is exported as env var or injected from GitHub Actions secrets
              auth_header="Authorization: token $GH_TOKEN"

              # Fetch GitHub profile for avatar URL
              avatar_url=$(curl -s -H "$auth_header" "https://api.github.com/users/$username" | jq -r '.avatar_url')

              # Enrich Zoho data with GitHub avatar
              enriched=$(echo "$row" | jq --arg avatar "$avatar_url" '. + {Avatar: $avatar}')

              # Manage commas between JSON objects
              if [ $first -eq 1 ]; then
                first=0
              else
                echo -e "," >> "$temp_file"
              fi

              # Write the enriched data to the temporary file
              echo "$enriched" >> "$temp_file"
          done

          # Close the JSON array
          echo "]" >> "$temp_file"

          # Format and save the final output to fixed.json
          cat "$temp_file" | jq . > maintainers.json

          # Clean up the temporary file
          rm "$temp_file"

      - name: Commit and push JSON files
        run: |
          set -euo pipefail
          cd armbian.github.io

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git fetch origin data
          git checkout data
          git pull --rebase origin data

          mkdir -p data
          cp "${{ github.workspace }}/partners.json" data/
          cp "${{ github.workspace }}/maintainers.json" data/

          git add data/partners.json data/maintainers.json
          if ! git diff --cached --quiet; then
            git commit -m "Update of Bigin sourced JSON files"
            # Push with retry logic
            max_attempts=3
            attempt=1
            while [ $attempt -le $max_attempts ]; do
              if git push origin data; then
                echo "Successfully pushed to data branch"
                exit 0
              fi

              # Pull with rebase to resolve conflicts
              echo "Push failed, attempting to pull and rebase..." >&2
              git pull --rebase origin data

              attempt=$((attempt + 1))
            done

            echo "Failed to push after $max_attempts attempts" >&2
            exit 1
          fi

      - name: "Generate directory"
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: "Web: Directory listing"
