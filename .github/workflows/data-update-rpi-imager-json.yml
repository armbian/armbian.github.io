name: "Data: Update Raspberry Pi imager JSON"
on:
  repository_dispatch:
    types: ["Data: Update RPI imager JSON"]
  workflow_dispatch:   # Manually triggered via GitHub Actions UI    

concurrency:
  group: rpi-imager-json-update
  cancel-in-progress: false

jobs:

  Webindex:

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    name: "Generate JSON Index"
    runs-on: "ubuntu-24.04"
    if: ${{ github.repository_owner == 'Armbian' }}
    permissions:
      contents: write
    timeout-minutes: 180
    steps:

      - name: Checkout armbian.github.io repository
        uses: actions/checkout@v6
        with:
          repository: armbian/armbian.github.io
          fetch-depth: 0
          clean: false
          path: armbian.github.io

      - name: "Install dependencies"
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: python3-requests xz-utils
          version: 1.0


      - name: "Build JSON file"
        run: |
          python3 ${{ github.workspace }}/armbian.github.io/scripts/generate-rpi-imager-json.py \
            --output "${{ github.workspace }}/rpi-imager.json"

      - name: Commit changes if any
        run: |
          set -euo pipefail
          cd armbian.github.io

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git fetch origin data
          git checkout data
          git pull --rebase origin data

          mkdir -p data
          cp "${{ github.workspace }}/rpi-imager.json" data/

          git add data/rpi-imager.json
          if ! git diff --cached --quiet; then
            git commit -m "Update WEB index files"
            # Push with retry logic
            max_attempts=3
            attempt=1
            while [ $attempt -le $max_attempts ]; do
              if git push origin data; then
                echo "Successfully pushed to data branch"
                exit 0
              fi

              # Pull with rebase to resolve conflicts
              echo "Push failed, attempting to pull and rebase..." >&2
              git pull --rebase origin data

              attempt=$((attempt + 1))
            done

            echo "Failed to push after $max_attempts attempts" >&2
            exit 1
          fi
