name: "Data: Update Raspberry Pi imager JSON"
on:
  repository_dispatch:
    types: ["Data: Update RPI imager JSON"]
  workflow_dispatch:   # Manually triggered via GitHub Actions UI    

concurrency:
  group: rpi-imager-json-update
  cancel-in-progress: false

jobs:

  Webindex:

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    name: "Generate JSON Index"
    runs-on: "ubuntu-24.04"
    if: ${{ github.repository_owner == 'Armbian' }}
    permissions:
      contents: write
    timeout-minutes: 180
    steps:

      - name: Checkout armbian.github.io repository
        uses: actions/checkout@v6
        with:
          repository: armbian/armbian.github.io
          fetch-depth: 0
          clean: false
          path: armbian.github.io

      - name: "Install dependencies"
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: python3-requests xz-utils
          version: 1.0


      - name: "Build JSON file"
        run: |
          python3 ${{ github.workspace }}/armbian.github.io/scripts/generate-rpi-imager-json.py \
            --output "${{ github.workspace }}/rpi-imager.json"

      - name: Commit changes if any
        run: |

          cd armbian.github.io
          git fetch origin data:remotes/origin/data || true
          git checkout data || git checkout -b data
          mkdir -p data/

          cp ${{ github.workspace }}/rpi-imager.json data/

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/.
          git diff --cached --quiet || git commit -m "Update WEB index files"
          git push origin data --force-with-lease
