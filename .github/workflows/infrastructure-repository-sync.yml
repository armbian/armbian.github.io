name: "Infrastructure: Repository sync"
on:
  push:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      forced_sync:
        type: boolean
        description: "Force synchronization"
        default: false
      dry_run:
        type: boolean
        description: "Dry run (show what would be transferred without actually syncing)"
        default: false

env:
  PUBLISHING_PATH: /publishing/repository
  #DRY_RUN_SYNC: ${{ inputs.dry_run || false }}
  DRY_RUN_SYNC: true
  SYNC_THRESHOLD_SECONDS: 36000

concurrency:
  group: pipeline
  cancel-in-progress: false

jobs:

  Check:
    name: "Check membership"
    runs-on: ubuntu-latest
    steps:

      - name: "Check membership"
        uses: armbian/actions/team-check@main
        with:
          ORG_MEMBERS: ${{ secrets.ORG_MEMBERS }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEAM: "Release manager"

  Prepare:
    needs: Check
    name: "Get mirror servers"
    outputs:
      matrix: ${{ steps.json.outputs.JSON_CONTENT }}
    runs-on: ubuntu-latest
    steps:

      - name: Get primary mirrors from database
        id: json
        shell: bash
        run: |
          set -e
          set -o pipefail

          NETBOX_API="${{ secrets.NETBOX_API }}"
          echo "### Fetching mirror list from NetBox" | tee -a "$GITHUB_STEP_SUMMARY"

          # Fetch all mirror data including configuration
          API_URL="${NETBOX_API}/virtualization/virtual-machines/?limit=500&name__empty=false&device_role=Mirror&tag=push&tag=debs&status=failed&status=active"

          response=$(curl -fsSL \
            --max-time 30 \
            --connect-timeout 10 \
            -H "Authorization: Token ${{ secrets.NETBOX_TOKEN }}" \
            -H "Accept: application/json" \
            "$API_URL" 2>&1) || exit 1

          # Build enriched JSON with server configuration
          mirror_json=$(echo "$response" | jq -r '.results[] | {
            name: .name,
            path: .custom_fields.path,
            port: .custom_fields.port,
            username: .custom_fields.username,
            download_path_debs: .custom_fields.download_path_debs
          } | select(.path != null and .port != null and .username != null)' | jq -s '.' 2>/dev/null)

          if [[ -z "$mirror_json" || "$mirror_json" == "null" || "$mirror_json" == "[]" ]]; then
            echo "::warning::No mirrors found in NetBox API response"
            echo 'JSON_CONTENT<<EOF' >> $GITHUB_OUTPUT
            echo '[]' >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
          else
            mirror_count=$(echo "$mirror_json" | jq 'length')
            echo "Found $mirror_count active mirrors" | tee -a "$GITHUB_STEP_SUMMARY"

            echo 'JSON_CONTENT<<EOF' >> $GITHUB_OUTPUT
            echo "$mirror_json" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT

            echo "" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "Mirror servers:" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "$mirror_json" | jq -r '.[].name' | sed 's/^/  - /' | tee -a "$GITHUB_STEP_SUMMARY"
          fi

  Sync:
    name: "Files"
    runs-on: repository-sync
    needs: Prepare
    outputs:
      matrix: ${{ needs.Prepare.outputs.matrix }}
    if: ${{ needs.Prepare.outputs.matrix != '[]' && needs.Prepare.outputs.matrix != '' }}
    timeout-minutes: 180
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        node: ${{ fromJson(needs.Prepare.outputs.matrix) }}

    steps:

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.KEY_UPLOAD }}
          known_hosts: ${{ secrets.KNOWN_HOSTS_ARMBIAN_UPLOAD }}
          if_key_exists: replace

      - name: Determine sync requirements
        id: check
        shell: bash
        run: |
          set -e
          set -o pipefail

          HOSTNAME="${{ matrix.node.name }}"
          DOWNLOAD_PATH="${{ matrix.node.download_path_debs }}"
          DOWNLOAD_PATH="${DOWNLOAD_PATH:-apt}"

          echo "### Checking sync requirements for $HOSTNAME" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "Download path: $DOWNLOAD_PATH" | tee -a "$GITHUB_STEP_SUMMARY"
          echo ""

          # Get remote repository timestamp
          REMOTE_DATE=$(wget --server-response --spider "https://${HOSTNAME}/${DOWNLOAD_PATH}/dists/jammy/InRelease" 2>&1 | grep -i 'Last-Modified:' | sed "s/^[^:]\+: //")

          if [[ -z "$REMOTE_DATE" ]]; then
            echo "::warning::Could not determine remote repository timestamp for $HOSTNAME"
            REMOTE_DATE=0
          else
            echo "Remote timestamp: $REMOTE_DATE" | tee -a "$GITHUB_STEP_SUMMARY"
          fi

          # Get local repository timestamp
          LOCAL_REPO_PATH="${{ env.PUBLISHING_PATH }}-debs/public"
          LOCAL_TIMESTAMP=$(stat -c%Y "$LOCAL_REPO_PATH/armbian.key")
          REMOTE_TIMESTAMP=$(date --date="$REMOTE_DATE" +%s 2>/dev/null || echo "0")

          # Calculate time difference
          DATEDIFF=$(echo "$LOCAL_TIMESTAMP - $REMOTE_TIMESTAMP" | bc)

          echo "Local timestamp: $LOCAL_TIMESTAMP" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "Remote timestamp: $REMOTE_TIMESTAMP" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "Time difference: $DATEDIFF seconds" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "Sync threshold: ${{ env.SYNC_THRESHOLD_SECONDS }} seconds" | tee -a "$GITHUB_STEP_SUMMARY"
          echo ""

          # Determine if sync is needed and set output
          if [[ "$DATEDIFF" -gt "${{ env.SYNC_THRESHOLD_SECONDS }}" ]]; then
            echo "✓ Sync is required (local is newer than threshold)" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "sync_needed=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.forced_sync }}" == "true" ]]; then
            echo "✓ Forced sync enabled" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "sync_needed=true" >> $GITHUB_OUTPUT
          else
            echo "::notice::Sync not required (repository is up to date)" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "sync_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync to mirror
        shell: bash
        if: steps.check.outputs.sync_needed == 'true'
        run: |
          set -e
          set -o pipefail

          # Use server configuration from matrix (fetched in Prepare job)
          HOSTNAME="${{ matrix.node.name }}"
          SERVER_PATH="${{ matrix.node.path }}"
          SERVER_PORT="${{ matrix.node.port }}"
          SERVER_USERNAME="${{ matrix.node.username }}"

          echo "### Server: $HOSTNAME" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "  Path: $SERVER_PATH" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "  Port: $SERVER_PORT" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "  Username: $SERVER_USERNAME" | tee -a "$GITHUB_STEP_SUMMARY"
          echo ""

          # Only sync debs (not debs-beta)
          REPO_PATH="${{ env.PUBLISHING_PATH }}-debs/public"
          RSYNC_OPTIONS="-av --size-only --omit-dir-times"

          if [[ "${{ env.DRY_RUN_SYNC }}" == "true" ]]; then
            RSYNC_OPTIONS="$RSYNC_OPTIONS --dry-run"
            echo "::notice::DRY_RUN_SYNC is enabled" | tee -a "$GITHUB_STEP_SUMMARY"
            echo ""
          fi

          # Remove old host key
          ssh-keygen -f "${HOME}/.ssh/known_hosts" -R "$HOSTNAME" 2>/dev/null || true

          # Initial sync (without delete)
          rsync $RSYNC_OPTIONS -e "ssh -p ${SERVER_PORT} -o StrictHostKeyChecking=accept-new -o ConnectTimeout=30" \
            "${REPO_PATH}/" \
            ${SERVER_USERNAME}@${HOSTNAME}:${SERVER_PATH}/apt 2>&1 | tee -a "$GITHUB_STEP_SUMMARY"

          # Final sync with delete
          rsync $RSYNC_OPTIONS --delete -e "ssh -p ${SERVER_PORT} -o StrictHostKeyChecking=accept-new -o ConnectTimeout=30" \
            "${REPO_PATH}/" \
            ${SERVER_USERNAME}@${HOSTNAME}:${SERVER_PATH}/apt 2>&1 | tee -a "$GITHUB_STEP_SUMMARY"

          echo "" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "✓ Sync completed for $HOSTNAME" | tee -a "$GITHUB_STEP_SUMMARY"

  dispatch:
    name: "Refresh web and redirector index"
    if: ${{ github.repository_owner == 'Armbian' }}
    needs: Sync
    runs-on: ubuntu-latest
    steps:

      - name: "Run redirector update action"
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.DISPATCH }}
          repository: armbian/armbian.github.io
          event-type: "Redirector update"
